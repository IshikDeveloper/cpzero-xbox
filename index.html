<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play Now! | Club Penguin Zero - Xbox Edition</title>
    <link rel="shortcut icon" href="https://play.cpzero.net/assets/sites/play.clubpenguin.com/themes/snowball/favicon.ico" type="image/vnd.microsoft.icon">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: #000;
            font-family: Arial, sans-serif;
        }

        /* Loading Screen */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999999;
            transition: opacity 0.5s ease-out;
        }

        #loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-logo {
            width: 300px;
            margin-bottom: 20px;
        }

        .loading-logo img {
            width: 100%;
            height: auto;
        }

        .loading-text {
            color: white;
            font-size: 20px;
            margin-top: 10px;
            text-align: center;
        }

        .loading-progress {
            width: 300px;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            margin-top: 20px;
            overflow: hidden;
        }

        .loading-bar {
            height: 100%;
            background: white;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Xbox Controller Hint */
        .controller-hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            z-index: 1000;
            display: none;
            text-align: center;
        }

        .controller-hint.active {
            display: block;
        }

        .controller-hint span {
            color: #0f0;
            font-weight: bold;
        }

        /* Game Container */
        #game-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        #content {
            width: 100%;
            height: 100%;
            position: relative;
        }

        ruffle-player {
            width: 100% !important;
            height: 100% !important;
        }

        /* Captcha Overlay */
        #captcha-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100000;
            flex-direction: column;
        }

        #captcha-overlay.active {
            display: flex;
        }

        #captcha-overlay h2 {
            color: white;
            margin-bottom: 20px;
            font-size: 24px;
        }

        #captcha-overlay p {
            color: #aaa;
            margin-bottom: 30px;
            text-align: center;
            max-width: 500px;
        }

        .cf-turnstile {
            transform: scale(1.2);
        }

        /* Memory Warning */
        .memory-warning {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 10000;
            display: none;
        }

        .memory-warning.show {
            display: block;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #0f0;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 10000;
            display: none;
        }

        .connection-status.show {
            display: block;
        }

        .connection-status.error {
            color: #f00;
        }
    </style>
</head>
<body>
    <!-- Captcha Overlay -->
    <div id="captcha-overlay">
        <h2>üîí Security Verification</h2>
        <p>Please complete the security check to continue. This helps protect Club Penguin Zero from bots.</p>
        <div id="turnstile-widget" class="cf-turnstile" data-sitekey="0x4AAAAAACCBKuQjFh5yFw16" data-callback="onTurnstileSuccess" data-error-callback="onTurnstileError" data-theme="dark"></div>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-logo">
            <img src="https://static.wikitide.net/cpimaginedwiki/thumb/6/65/Club_Penguin_Zero_logo.gif/300px-Club_Penguin_Zero_logo.gif" alt="Club Penguin Zero">
        </div>
        <div class="loading-text">Loading Club Penguin Zero for Xbox...</div>
        <div class="loading-progress">
            <div class="loading-bar" id="loading-bar"></div>
        </div>
    </div>

    <!-- Controller Hint -->
    <div class="controller-hint" id="controller-hint">
        üéÆ Xbox Controller Connected<br>
        <span>Left Stick</span>: Move | <span>A</span>: Click | <span>B</span>: Back
    </div>

    <!-- Connection Status -->
    <div class="connection-status" id="connection-status">
        Connecting to server...
    </div>

    <!-- Memory Warning -->
    <div class="memory-warning" id="memory-warning">
        ‚ö†Ô∏è Low Memory Detected - Performance May Degrade
    </div>

    <!-- Game Container -->
    <div id="game-container">
        <main id="content"></main>
    </div>

    <!-- Cloudflare Turnstile -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

    <!-- Ruffle Flash Emulator -->
    <script src="https://unpkg.com/@ruffle-rs/ruffle"></script>

    <!-- Main Script -->
    <script>
        const media = "https://media.cpzero.net/";
        let rufflePlayer = null;
        let captchaToken = null;
        let captchaRequired = false;

        // Captcha handling
        function onTurnstileSuccess(token) {
            console.log("‚úÖ Captcha verified successfully");
            captchaToken = token;
            document.getElementById('captcha-overlay').classList.remove('active');
            
            // Send token to Flash/Ruffle if it's waiting
            if (rufflePlayer) {
                try {
                    rufflePlayer.finishedCaptcha(String(token));
                    updateConnectionStatus("Captcha verified", false);
                } catch (e) {
                    console.error("Error sending token to Flash:", e);
                }
            }
        }

        function onTurnstileError(code) {
            console.error("‚ùå Captcha error:", code);
            captchaToken = null;
            updateConnectionStatus("Captcha failed - retrying...", true);
            
            // Auto-retry after 2 seconds
            setTimeout(() => {
                if (window.turnstile) {
                    turnstile.reset();
                }
            }, 2000);
        }

        function showCaptcha() {
            console.log("üìã Showing captcha overlay");
            document.getElementById('captcha-overlay').classList.add('active');
            captchaRequired = true;
            
            // Auto-execute invisible captcha
            setTimeout(() => {
                if (window.turnstile) {
                    turnstile.execute("#turnstile-widget");
                }
            }, 500);
        }

        function getCaptchaToken() {
            if (!captchaToken) {
                showCaptcha();
                return null;
            }
            return captchaToken;
        }

        function triggerCaptcha() {
            showCaptcha();
        }

        function grecaptchaSubmit() {
            showCaptcha();
        }

        function updateConnectionStatus(message, isError) {
            const statusEl = document.getElementById('connection-status');
            statusEl.textContent = message;
            statusEl.classList.toggle('error', isError);
            statusEl.classList.add('show');
            
            if (!isError) {
                setTimeout(() => {
                    statusEl.classList.remove('show');
                }, 3000);
            }
        }

        // Xbox-Optimized Ruffle Config
        window.RufflePlayer = window.RufflePlayer || {};
        window.RufflePlayer.config = {
            quality: "low",
            scale: "exactfit",
            letterbox: "off",
            forceAlign: false,
            forceScale: true,
            maxExecutionDuration: 15,
            splashScreen: false,
            autoplay: "on",
            unmuteOverlay: "hidden",
            fontSources: [media + "play/v2/client/fonts/en/FontLibrary.swf"],
            socketProxy: [
                {
                    host: "server.cpzero.net",
                    port: 6112,
                    proxyUrl: "wss://server.cpzero.net/login"
                },
                {
                    host: "server.cpzero.net",
                    port: 9875,
                    proxyUrl: "wss://server.cpzero.net/sub_zero"
                },
                {
                    host: "server.cpzero.net",
                    port: 9876,
                    proxyUrl: "wss://server.cpzero.net/below_zero"
                }
            ],
            allowScriptAccess: true,
            warnOnUnsupportedContent: false,
            preferredRenderer: "webgl",
            backgroundColor: "#000000"
        };

        // Xbox Controller Support
        class XboxController {
            constructor() {
                this.gamepad = null;
                this.lastButtons = [];
                this.cursorX = window.innerWidth / 2;
                this.cursorY = window.innerHeight / 2;
                this.cursorSpeed = 8;
                this.deadzone = 0.15;
                this.cursor = this.createCursor();
                
                window.addEventListener('gamepadconnected', (e) => this.onConnect(e));
                window.addEventListener('gamepaddisconnected', (e) => this.onDisconnect(e));
                this.pollGamepad();
            }
            
            createCursor() {
                const cursor = document.createElement('div');
                cursor.style.cssText = `
                    position: fixed;
                    width: 20px;
                    height: 20px;
                    background: rgba(0, 255, 0, 0.8);
                    border: 2px solid white;
                    border-radius: 50%;
                    pointer-events: none;
                    z-index: 99999;
                    display: none;
                    transform: translate(-50%, -50%);
                `;
                document.body.appendChild(cursor);
                return cursor;
            }
            
            onConnect(e) {
                console.log("üéÆ Controller Connected:", e.gamepad.id);
                this.gamepad = e.gamepad;
                this.cursor.style.display = 'block';
                document.getElementById('controller-hint').classList.add('active');
                setTimeout(() => {
                    document.getElementById('controller-hint').classList.remove('active');
                }, 5000);
            }
            
            onDisconnect(e) {
                console.log("üéÆ Controller Disconnected");
                this.gamepad = null;
                this.cursor.style.display = 'none';
            }
            
            pollGamepad() {
                if (this.gamepad) {
                    const gamepads = navigator.getGamepads();
                    this.gamepad = gamepads[this.gamepad.index];
                    if (this.gamepad) this.handleInput();
                }
                requestAnimationFrame(() => this.pollGamepad());
            }
            
            handleInput() {
                const gp = this.gamepad;
                let axisX = Math.abs(gp.axes[0]) > this.deadzone ? gp.axes[0] : 0;
                let axisY = Math.abs(gp.axes[1]) > this.deadzone ? gp.axes[1] : 0;
                
                if (axisX !== 0 || axisY !== 0) {
                    this.cursorX += axisX * this.cursorSpeed;
                    this.cursorY += axisY * this.cursorSpeed;
                    this.cursorX = Math.max(0, Math.min(window.innerWidth, this.cursorX));
                    this.cursorY = Math.max(0, Math.min(window.innerHeight, this.cursorY));
                    this.cursor.style.left = this.cursorX + 'px';
                    this.cursor.style.top = this.cursorY + 'px';
                }
                
                if (gp.buttons[0].pressed && !this.lastButtons[0]) {
                    this.simulateClick(this.cursorX, this.cursorY);
                }
                
                if (gp.buttons[1].pressed && !this.lastButtons[1]) {
                    this.simulateClick(this.cursorX, this.cursorY, true);
                }
                
                // D-pad for WASD
                if (gp.buttons[12].pressed) this.simulateKey('W', 87);
                if (gp.buttons[13].pressed) this.simulateKey('S', 83);
                if (gp.buttons[14].pressed) this.simulateKey('A', 65);
                if (gp.buttons[15].pressed) this.simulateKey('D', 68);
                
                this.lastButtons = gp.buttons.map(b => b.pressed);
            }
            
            simulateClick(x, y, rightClick = false) {
                const target = document.querySelector('ruffle-player') || document.elementFromPoint(x, y);
                if (target) {
                    const event = new MouseEvent(rightClick ? 'contextmenu' : 'click', {
                        bubbles: true,
                        cancelable: true,
                        clientX: x,
                        clientY: y,
                        button: rightClick ? 2 : 0
                    });
                    target.dispatchEvent(event);
                }
            }
            
            simulateKey(key, keyCode) {
                const ruffle = document.querySelector('ruffle-player');
                if (ruffle) {
                    const event = new KeyboardEvent('keydown', {
                        key: key,
                        keyCode: keyCode,
                        bubbles: true
                    });
                    ruffle.dispatchEvent(event);
                }
            }
        }

        // Memory Monitor
        class MemoryMonitor {
            constructor() {
                this.checkInterval = 5000;
                this.warningShown = false;
                this.startMonitoring();
            }
            
            startMonitoring() {
                setInterval(() => {
                    if (performance.memory) {
                        const usedMB = performance.memory.usedJSHeapSize / 1048576;
                        const limitMB = performance.memory.jsHeapSizeLimit / 1048576;
                        const usage = (usedMB / limitMB) * 100;
                        
                        if (usage > 80 && !this.warningShown) {
                            document.getElementById('memory-warning').classList.add('show');
                            this.warningShown = true;
                            if (window.gc) window.gc();
                        }
                    }
                }, this.checkInterval);
            }
        }

        // Loading Manager
        class LoadingManager {
            constructor() {
                this.loadingBar = document.getElementById('loading-bar');
                this.loadingScreen = document.getElementById('loading-screen');
                this.progress = 0;
            }
            
            updateProgress(percent) {
                this.progress = Math.min(percent, 100);
                this.loadingBar.style.width = this.progress + '%';
                
                if (this.progress >= 100) {
                    setTimeout(() => {
                        this.loadingScreen.classList.add('hidden');
                        setTimeout(() => this.loadingScreen.remove(), 500);
                    }, 500);
                }
            }
            
            startFakeProgress() {
                const interval = setInterval(() => {
                    this.progress += 5;
                    this.updateProgress(this.progress);
                    if (this.progress >= 90) clearInterval(interval);
                }, 300);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const loadingManager = new LoadingManager();
            loadingManager.startFakeProgress();
            
            const controller = new XboxController();
            const memoryMonitor = new MemoryMonitor();
            
            // Auto-show captcha on load
            setTimeout(() => showCaptcha(), 1000);
            
            // Load Ruffle
            const ruffle = window.RufflePlayer.newest();
            const player = ruffle.createPlayer();
            const container = document.getElementById('content');
            container.appendChild(player);
            rufflePlayer = player;
            
            player.style.width = '100%';
            player.style.height = '100%';
            
            const swfUrl = media + 'play/v2/client/club_penguin.swf?clientVersion=21639';
            const flashvars = {
                play: media + 'play/',
                client: media + 'play/v2/client/',
                content: media + 'play/v2/content/',
                games: media + 'play/v2/games/',
                connectionID: 'cp68294',
                a: '0',
                p: '1',
                lang: 'en',
                phrasechat: media + 'social/autocomplete/v2/search/',
                isAS3WebServicesOn: 'true',
                clientVersion: '21639',
                configVersion: '1485906035',
                contentVersion: '84421',
                minigameVersion: '13162'
            };
            
            const flashvarsString = Object.entries(flashvars)
                .map(([k, v]) => `${k}=${encodeURIComponent(v)}`)
                .join('&');
            
            player.load({
                url: swfUrl,
                parameters: flashvarsString,
                allowScriptAccess: true,
                quality: 'low',
                wmode: 'direct'
            });
            
            player.addEventListener('loadeddata', () => {
                console.log('‚úÖ Game loaded');
                loadingManager.updateProgress(100);
            });
            
            player.addEventListener('error', (e) => {
                console.error('‚ùå Ruffle error:', e);
                updateConnectionStatus('Error loading game - refresh page', true);
            });
            
            console.log('üéÆ Club Penguin Zero - Xbox Edition Initialized');
        });
    </script>
</body>
</html>
